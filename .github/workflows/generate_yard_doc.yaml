name: Generate project YARD documentation

on:
  push:
    if: github.event.pull_request.merged == true

jobs:
  build:
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    runs-on: ubuntu-latest
    steps:
    - uses: ruby/setup-ruby@v1.50.0
      with:
        ruby-version: 2.7
        bundler-cache: true

    - uses: actions/checkout@v2
      with:
        repository: sebastian-palma/maindoc
        path: maindoc

    - name: Update changes
      run: |
             gem install yard
             sudo apt install wget unzip -y
             wget --no-check-certificate --content-disposition https://github.com/sebastian-palma/yard-template/archive/main.zip
             unzip -q yard-template-main.zip
             mv yard-template-main template
             yardoc --protected --private -p template
             cp -avr doc/ maindoc/app/views/docs/yard/doctest/
             rm -rf maindoc/app/views/docs/yard/doctest/js
             rm -rf maindoc/app/views/docs/yard/doctest/css
             cat maindoc/app/views/docs/yard/doctest/class_list.html
             cd maindoc
             git config user.name github-actions
             git config user.email github-actions@github.com
             git status
             git add -A
             git commit -m "Update doctest YARD docs."
             git push https://$USERNAME:$REPO_KEY@github.com/maindoc.git $GITHUB_REF
      env:
        REPO_KEY: ${{ secrets.PAT_FOR_PUSH }}
        USERNAME: github-actions
         
